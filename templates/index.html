<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Zone Drawer</title>
    <style>
        canvas {
            border: 2px solid #000;
        }

        #save {
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <h2>Draw Zones</h2>
    <canvas id="canvas" width="640" height="480"></canvas>
    <br />
    <button id="save">Save Zones</button>
    <button id="clear">Clear All</button>
    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const img = new Image();
        img.src = '/static/snapshot.jpg'; // serve from Flask static folder
        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

        let points = [];
        let zones = [];

        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            points.push([x, y]);
            redraw();

            if (points.length > 1) {
                ctx.beginPath();
                ctx.moveTo(points[points.length - 2][0], points[points.length - 2][1]);
                ctx.lineTo(x, y);
                ctx.stroke();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && points.length > 2) {
                // Close polygon
                zones.push(points);
                points = [];
                redraw();
            }
        });

        document.getElementById('save').addEventListener('click', () => {
            if (points.length > 2) {
                zones.push(points);
                points = [];
                redraw();
            }
            fetch('/save_zones', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ zones: zones })
            }).then(res => alert('Zones saved!'));
        });

        document.getElementById('clear').addEventListener('click', () => {
            zones = [];
            points = [];
            redraw();
        });

        function redraw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(0, 255, 0, 0.3)';
            ctx.strokeStyle = '#0f0';

            zones.forEach(zone => {
                ctx.beginPath();
                ctx.moveTo(zone[0][0], zone[0][1]);
                zone.forEach(([x, y]) => ctx.lineTo(x, y));
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
            });

            if (points.length > 0) {
                ctx.beginPath();
                ctx.moveTo(points[0][0], points[0][1]);
                points.forEach(([x, y]) => ctx.lineTo(x, y));
                ctx.stroke();
            }
        }
    </script>
    <p>Click to add points. Press Enter to finish a polygon. Click Save to store all zones.</p>
</body>

</html>